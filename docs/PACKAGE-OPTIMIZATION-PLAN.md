# 小程序包体积优化实施方案

## 一、现状分析

### 1. 当前问题
- ❌ 主包大小超过 1.5M（微信小程序建议限制）
- ❌ JS文件未进行压缩
- ❌ 未启用组件按需注入

### 2. 影响分析
- **主包超限**：可能无法发布，影响用户首次加载体验
- **JS未压缩**：增加包体积和加载时间
- **组件未按需注入**：加载不必要的组件，影响启动速度

## 二、优化方案设计

### 阶段一：主包大小优化（优先级：高）

#### 1.1 主包组成分析
需要分析当前主包包含的内容：
- 页面文件
- 静态资源（图片、音频、JSON数据）
- 第三方库（uni_modules）
- 组件文件

#### 1.2 优化策略
1. **移动页面到分包**
   - 将非核心页面移到分包
   - 保留启动必需页面在主包

2. **静态资源优化**
   - 大图片改为网络加载
   - 音频文件移到云存储
   - JSON数据文件按需加载

3. **第三方库优化**
   - 分析uni_modules占用
   - 移除未使用的模块
   - 考虑CDN引入

#### 1.3 主包保留内容
- 启动页（pages/index/index）
- 首页（pages/home/home）
- 登录页（pages/login/login）
- TabBar页面
- 核心组件
- 必要的工具类

### 阶段二：JS压缩配置（优先级：中）

#### 2.1 manifest.json配置
```json
"mp-weixin": {
  "setting": {
    "es6": true,
    "postcss": true,
    "minified": true,
    "uglifyFileName": true
  }
}
```

#### 2.2 微信开发者工具配置
- 开启"压缩代码"选项
- 开启"压缩样式文件"选项

### 阶段三：组件按需注入（优先级：中）

#### 3.1 配置方式
在编译后的`app.json`中添加：
```json
{
  "lazyCodeLoading": "requiredComponents"
}
```

#### 3.2 uni-app配置
需要在manifest.json中配置微信小程序的相关设置

## 三、实施步骤

### Step 1: 分析主包大小
1. 编译项目到微信小程序
2. 查看主包实际大小和组成
3. 识别占用空间最大的文件

### Step 2: 移动非核心页面到分包
1. 识别可移动的页面
2. 调整pages.json配置
3. 更新路径引用

### Step 3: 优化静态资源
1. 压缩图片
2. 移动大文件到云端
3. 实现按需加载

### Step 4: 配置压缩和按需加载
1. 更新manifest.json
2. 添加构建配置
3. 验证效果

## 四、预期效果

### 优化前
- 主包大小：>1.5MB
- JS文件：未压缩
- 组件加载：全量加载

### 优化后目标
- 主包大小：<1MB
- JS文件：压缩50%+
- 组件加载：按需加载
- 启动速度：提升30%+

## 五、风险控制

1. **分包调整风险**
   - 备份当前pages.json
   - 逐步移动页面
   - 充分测试跳转

2. **压缩配置风险**
   - 先在开发环境测试
   - 保留源码映射
   - 注意兼容性

3. **回滚方案**
   - 保存配置快照
   - 文档记录变更
   - 可快速恢复
