# WS-M1-W1-003: 同意管理流程实现

**工作流ID**: WS-M1-W1-003  
**标题**: 实现隐私政策同意、用户协议展示  
**分支**: `feat/WS-M1-W1-003-consent-flow`  
**阶段**: M1-Week1 基础模块  
**负责人**: 前端A  
**状态**: 📝 五件套准备中  
**预计工时**: 8h

---

## 快速导航

- [📋 PLAN.md](./PLAN.md) - 详细计划与数据流
- [🔧 PATCH.md](./PATCH.md) - 完整代码（3个页面+云函数）
- [✅ TESTS.md](./TESTS.md) - 测试用例与可运行脚本
- [📝 SELF-REVIEW.md](./SELF-REVIEW.md) - 自检清单（9项DoD）
- [⏮️ ROLLBACK.md](./ROLLBACK.md) - 回滚方案

---

## 工作流概述

### 目标

实现符合法规要求的隐私同意管理流程，确保首次使用必须同意相关协议，用户可查看和撤回同意。

### 背景分析

**现有代码**:
- ✅ `pages/login/login.vue` 已有简单的协议勾选（checkbox + 弹窗展示）
- ✅ `static/copy/disclaimer.md` 已有免责声明内容
- ✅ `utils/route-guard.js` 已有路由守卫框架
- ❌ 缺少独立的同意管理页面
- ❌ 缺少隐私政策和用户协议完整内容
- ❌ 缺少同意记录到数据库
- ❌ 缺少撤回同意功能

### 核心任务

1. ✅ 创建独立的同意页面（pages/consent/consent.vue）
2. ✅ 创建隐私政策展示页（pages/consent/privacy-policy.vue）
3. ✅ 创建用户协议展示页（pages/consent/user-agreement.vue）
4. ✅ 实现首次启动强制同意流程
5. ✅ 同意状态记录到Supabase
6. ✅ 路由守卫集成（未同意禁止访问）
7. ✅ 撤回同意功能入口（M2完善）

---

## 影响范围

### 新建文件（4个页面+1个云函数）

**前端页面**:
- `pages/consent/consent.vue`（约400行）- 同意管理主页
- `pages/consent/privacy-policy.vue`（约300行）- 隐私政策
- `pages/consent/user-agreement.vue`（约300行）- 用户协议
- `pages/consent/disclaimer.vue`（约200行）- 免责声明

**云函数**:
- `uniCloud-aliyun/cloudfunctions/consent-record/index.js`（约120行）- 记录同意状态

**配置**:
- `pages.json`（小改）- 新增页面路由

### 小改文件（2个）

- `utils/route-guard.js`（小改）- 添加同意检查逻辑
- `App.vue`（小改）- 首次启动检查同意状态

### 复用文件（1个）

- `static/copy/disclaimer.md`（复用）- 免责声明内容源

---

## 依赖关系

### 前置依赖

- **WS-M0-001**: UI组件库统一（consent页面使用uView组件）
- **WS-M1-W1-001**: 微信登录（同意状态关联用户）

### 后置依赖

- **所有功能页面**: 未同意时禁止访问
- **WS-M2-W6-002**: 撤回同意功能完善

---

## 风险提示

| 风险项 | 可能性 | 影响度 | 缓解措施 | 状态 |
|--------|--------|--------|----------|------|
| **首次启动强制同意影响体验** | 高 | 中 | 1. UI设计友好<br>2. 内容简洁<br>3. 跳过链接 | ⬜ 待验证 |
| **协议内容不符合法规** | 中 | 高 | 1. 法务审核<br>2. 参考行业标准<br>3. 定期更新 | ⬜ 待验证 |
| **同意状态记录失败** | 中 | 中 | 1. 本地缓存兜底<br>2. 离线可用<br>3. 后台同步 | ⬜ 待验证 |
| **路由守卫过严导致无法使用** | 低 | 高 | 1. 白名单机制<br>2. 游客模式<br>3. 降级方案 | ⬜ 待验证 |

---

## 成功标准

### 必达目标（P0）

- [ ] ✅ 首次启动显示同意页面
- [ ] ✅ 必须同意才能继续使用
- [ ] ✅ 可查看完整协议内容
- [ ] ✅ 同意状态持久化
- [ ] ✅ 同意状态记录到云端

### 质量目标（P1）

- [ ] ✅ 协议内容完整清晰
- [ ] ✅ UI设计友好美观
- [ ] ✅ 加载流畅（<1s）

---

**文档版本**: v1.0  
**创建日期**: 2025-10-12  
**最后更新**: 2025-10-12

