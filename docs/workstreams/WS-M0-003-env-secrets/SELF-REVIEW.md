# WS-M0-003: 自检清单 (SELF-REVIEW)

**工作流ID**: WS-M0-003  
**审核人**: _______  
**审核日期**: _______

---

## 一、工程硬约束检查（必须全部✅）

### 1.1 构建检查
- [ ] ✅ **构建 0 报错**
  ```bash
  npm run build:mp-weixin
  # 预期: Build complete. 无error
  ```

### 1.2 UI组件库统一
- [ ] ✅ **uView 2.x 唯一**（本工作流不影响）
  - N/A: ⬜

### 1.3 Node环境检查
- [ ] ✅ **Node 16 CJS**
  ```bash
  npm run check:engines
  # 预期: ✅ Node 16.x.x
  ```
  ```bash
  npm run check:esm
  # 预期: ✅ 所有云函数使用CJS
  ```

### 1.4 数据路径检查
- [ ] ✅ **前端不直连 Supabase**
  ```bash
  npm run check:supabase
  # 预期: ✅ 无直连
  ```

### 1.5 密钥安全检查 ⭐ **本工作流重点**
- [ ] ✅ **无明文密钥**
  ```bash
  # 检查代码中无硬编码API Key
  grep -r "sk-[a-zA-Z0-9]\\{48\\}" uniCloud-aliyun/cloudfunctions --exclude-dir=node_modules
  # 预期: 无结果
  
  # 检查ESLint规则
  npm run lint
  # 预期: 无 no-restricted-syntax 关于密钥的error
  
  # 检查.env不在Git中
  git status | grep -q ".env$"
  # 预期: exit code 1 (不在状态中)
  ```
  
  **详细检查**:
  - stress-chat/index.js 无硬编码: ⬜ 是
  - common/secrets/supabase.js 使用环境变量: ⬜ 是
  - .env 在 .gitignore: ⬜ 是
  - Git历史无密钥泄露: ⬜ 是

### 1.6-1.9 其他约束
- [ ] ✅ 语音不落盘：N/A（本工作流不涉及）
- [ ] ✅ 首包 ≤2MB：无影响（无新增代码）
- [ ] ✅ 关键路径 P95 ≤800ms：无影响
- [ ] ✅ 回归脚本通过
  ```bash
  ./test-ws-m0-003.sh
  # 预期: ✅ 基础检查通过
  ```

---

## 二、代码质量检查

### 2.1 云函数代码
- [ ] **stress-chat/index.js 修改正确**
  - 移除硬编码: ⬜ 是
  - 使用 process.env: ⬜ 是
  - 添加配置验证: ⬜ 是
  - 错误提示清晰: ⬜ 是

- [ ] **common/secrets/supabase.js 验证通过**
  - 使用环境变量: ⬜ 是
  - 配置验证（如已添加）: ⬜ 是

### 2.2 配置文件
- [ ] **.env.example 完整**
  - 包含所有必需变量: ⬜ 是（6个）
  - 格式正确: ⬜ 是
  - 示例值安全（非真实值）: ⬜ 是
  - 注释清晰: ⬜ 是

- [ ] **.gitignore 更新**
  - .env 已添加: ⬜ 是
  - .env.local 等变体已添加: ⬜ 是
  - 密钥文件已忽略: ⬜ 是

### 2.3 验证脚本
- [ ] **check-env-vars.js 功能完整**
  - 可正常运行: ⬜ 是
  - 检查所有必需变量: ⬜ 是
  - 格式验证准确: ⬜ 是
  - 错误提示清晰: ⬜ 是
  - 检查.gitignore: ⬜ 是

### 2.4 代码规范
- [ ] **ESLint检查通过**
  ```bash
  npm run lint
  ```
  - 0 errors: ⬜ 是
  - Warnings合理: ⬜ 是

- [ ] **代码注释**
  - 关键逻辑有注释: ⬜ 是
  - 配置说明清晰: ⬜ 是

---

## 三、功能完整性检查

### 3.1 核心功能
- [ ] **OpenAI API Key 迁移**
  - stress-chat 使用环境变量: ⬜ 是
  - 配置验证逻辑: ⬜ 是
  - 错误处理完善: ⬜ 是

- [ ] **Supabase 配置验证**
  - 确认使用环境变量: ⬜ 是
  - 配置验证（如适用）: ⬜ 是

- [ ] **.env.example 创建**
  - 文件存在: ⬜ 是
  - 内容完整: ⬜ 是

- [ ] **验证脚本开发**
  - check-env-vars.js 存在: ⬜ 是
  - package.json scripts 添加: ⬜ 是

### 3.2 文档创建
- [ ] **docs/deployment-guide.md**
  - 文件存在: ⬜ 是
  - 本地环境配置: ⬜ 完整
  - 云端环境配置: ⬜ 完整
  - 常见问题: ⬜ 完整
  - 安全建议: ⬜ 完整

- [ ] **docs/env-variables-guide.md**
  - 文件存在: ⬜ 是
  - 所有变量说明: ⬜ 完整
  - 获取方式: ⬜ 清晰
  - 安全清单: ⬜ 完整
  - 故障排查: ⬜ 完整

### 3.3 Git安全
- [ ] **.gitignore 配置**
  - .env 被忽略: ⬜ 是
  - git status 验证: ⬜ 是
  - git check-ignore 验证: ⬜ 是

- [ ] **Git历史清理**（如需要）
  - 检查历史提交: ⬜ 已检查
  - 无密钥泄露: ⬜ 是
  - 或已清理: ⬜ 是

---

## 四、测试覆盖检查

### 4.1 验证脚本测试
- [ ] **正常场景**
  - 所有变量配置正确: ⬜ 通过
  - check:env 通过: ⬜ 是

- [ ] **异常场景**
  - 缺少变量: ⬜ 正确报错
  - 格式错误: ⬜ 正确报错
  - .env未忽略: ⬜ 正确警告

### 4.2 云函数测试
- [ ] **stress-chat 测试**
  - 环境变量读取: ⬜ 正常
  - 未配置时报错: ⬜ 是
  - 格式错误时警告: ⬜ 是

- [ ] **Supabase 配置测试**
  - 配置正确读取: ⬜ 是
  - 验证逻辑（如有）: ⬜ 正常

### 4.3 部署流程测试
- [ ] **本地开发**
  - 按文档配置成功: ⬜ 是
  - check:env 通过: ⬜ 是
  - 启动无错误: ⬜ 是

- [ ] **云端部署**（如已测试）
  - 配置环境变量: ⬜ 成功
  - 云函数调用: ⬜ 正常
  - 无配置错误: ⬜ 是

### 4.4 文档测试
- [ ] **文档可用性**
  - 新成员可独立配置: ⬜ 是
  - 步骤清晰: ⬜ 是
  - 常见问题有答案: ⬜ 是

---

## 五、安全检查 ⭐ **重点**

### 5.1 密钥保护
- [ ] **代码中无明文密钥**
  ```bash
  grep -r "sk-" . --exclude-dir=node_modules --exclude-dir=.git --exclude=".env.example"
  # 预期: 无真实密钥
  ```
  - stress-chat: ⬜ 无硬编码
  - supabase配置: ⬜ 无硬编码
  - 其他文件: ⬜ 无硬编码

- [ ] **Git安全**
  - .env 在 .gitignore: ⬜ 是
  - .env.example 无真实值: ⬜ 是
  - Git历史无泄露: ⬜ 是

- [ ] **ESLint规则**
  - 可检测硬编码: ⬜ 是
  - 测试用例通过: ⬜ 是

### 5.2 权限最小化
- [ ] **密钥使用范围**
  - service_role_key 仅云函数: ⬜ 是
  - anon_key 仅前端（如使用）: ⬜ 是
  - 各密钥用途明确: ⬜ 是

### 5.3 文档安全
- [ ] **安全建议完整**
  - 密钥管理: ⬜ 是
  - 访问控制: ⬜ 是
  - 监控审计: ⬜ 是
  - 密钥轮换: ⬜ 是

---

## 六、文档完整性检查

### 6.1 五件套文档
- [x] **README.md**: ⬜ 完整
- [x] **PLAN.md**: ⬜ 完整
- [x] **PATCH.md**: ⬜ 完整
- [x] **TESTS.md**: ⬜ 完整
- [x] **SELF-REVIEW.md**（本文档）: ⬜ 完整
- [x] **ROLLBACK.md**: ⬜ 待创建

### 6.2 技术文档
- [ ] **deployment-guide.md**: ⬜ 完整清晰
- [ ] **env-variables-guide.md**: ⬜ 完整清晰

### 6.3 代码注释
- [ ] **云函数注释**: ⬜ 完整
- [ ] **验证脚本注释**: ⬜ 完整
- [ ] **.env.example 注释**: ⬜ 清晰

---

## 七、Git提交检查

### 7.1 分支管理
- [ ] **分支命名正确**
  - 分支名: ⬜ `feat/WS-M0-003-env-secrets`

### 7.2 提交信息
- [ ] **Commit信息规范**
  ```
  feat(WS-M0-003): 迁移密钥到环境变量
  
  - 移除stress-chat中的硬编码API Key
  - 验证Supabase配置使用环境变量
  - 创建.env.example模板
  - 开发环境变量验证脚本
  - 编写部署指南和环境变量指南
  - 更新.gitignore
  
  安全:
  - 无明文密钥
  - .env已忽略
  - ESLint可检测硬编码
  ```

### 7.3 文件变更
- [ ] **变更文件合理**
  - 无多余文件: ⬜ 是
  - 无真实密钥: ⬜ 是
  - .env 不在暂存区: ⬜ 是

### 7.4 提交前检查
- [ ] **.env 未暂存**
  ```bash
  git diff --cached --name-only | grep -q "^\.env$"
  # 预期: exit code 1 (不在暂存区)
  ```

- [ ] **无密钥内容**
  ```bash
  git diff --cached | grep -i "api_key\|secret\|password"
  # 预期: 仅在.env.example中，且为示例值
  ```

---

## 八、验收标准（最终确认）

### 8.1 核心目标
- [ ] ✅ OpenAI API Key 迁移到环境变量
- [ ] ✅ Supabase 密钥确认使用环境变量
- [ ] ✅ .env.example 创建完成
- [ ] ✅ 验证脚本开发完成
- [ ] ✅ 部署指南完成
- [ ] ✅ 环境变量指南完成

### 8.2 质量标准
- [ ] ✅ 代码中无明文密钥
- [ ] ✅ .env 在 .gitignore
- [ ] ✅ Git历史无泄露
- [ ] ✅ check:env 通过
- [ ] ✅ 文档清晰完整

### 8.3 安全标准 ⭐
- [ ] ✅ 所有密钥通过环境变量管理
- [ ] ✅ .env 文件被忽略
- [ ] ✅ ESLint 可检测硬编码
- [ ] ✅ 文档包含安全建议
- [ ] ✅ 密钥轮换流程明确

---

## 九、自检结论

### 9.1 检查结果
**工程硬约束（9项）**: ___ / 9 ✅  
**代码质量**: ___ / 4 ✅  
**功能完整性**: ___ / 3 ✅  
**测试覆盖**: ___ / 4 ✅  
**安全检查**: ___ / 3 ✅  
**文档完整性**: ___ / 3 ✅  

**总计**: ___ / 26 ✅

### 9.2 最终结论
- [ ] ✅ **通过** - 可以提交PR，安全审查通过
- [ ] ⚠️ **有问题** - 需修复后重审
- [ ] ❌ **不通过** - 需重新开发

### 9.3 发现问题清单
| 编号 | 问题描述 | 优先级 | 状态 |
|------|----------|--------|------|
| 1 | | P_ | 待修复 |

### 9.4 安全评估 ⭐
- [ ] **无安全隐患**: 所有密钥已保护
- [ ] **有小问题**: [描述]，可接受
- [ ] **有安全风险**: [描述]，必须修复

---

## 十、审核签字

### 自检人
- **姓名**: _______
- **日期**: _______
- **结论**: [ ] 通过  [ ] 有问题

### 安全审核人
- **姓名**: _______
- **日期**: _______
- **结论**: [ ] 通过  [ ] 有问题
- **安全评估**: _______

### Code Review人
- **姓名**: _______
- **日期**: _______
- **结论**: [ ] 通过  [ ] 有问题

### Tech Lead审批
- **姓名**: _______
- **日期**: _______
- **批准合并**: [ ] 是  [ ] 否
- **备注**: _______

---

**自检状态**: 待完成  
**最后更新**: _______  
**特别提醒**: 本工作流涉及密钥安全，务必完成所有安全检查项！

