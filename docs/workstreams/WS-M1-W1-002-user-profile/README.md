# WS-M1-W1-002: 用户信息页面完善

**工作流ID**: WS-M1-W1-002  
**标题**: 完善个人中心和个人资料页  
**分支**: `feat/WS-M1-W1-002-user-profile`  
**阶段**: M1-Week1 基础模块  
**负责人**: 前端A  
**状态**: 📝 五件套准备中  
**预计工时**: 4h  
**实际工时**: ___h

---

## 快速导航

- [📋 PLAN.md](./PLAN.md) - 详细计划与数据流分析
- [🔧 PATCH.md](./PATCH.md) - 完整代码差异（profile.vue完整实现）
- [✅ TESTS.md](./TESTS.md) - 测试用例与验证脚本
- [📝 SELF-REVIEW.md](./SELF-REVIEW.md) - 自检清单（9项硬约束）
- [⏮️ ROLLBACK.md](./ROLLBACK.md) - 回滚方案

---

## 工作流概述

### 目标

完善用户信息相关页面，实现完整的个人资料编辑功能，确保用户可以查看和修改个人信息。

### 背景分析

从代码审查发现：

**pages/user/home.vue**（502行）：
- ✅ 功能完善：用户信息卡片、功能菜单、快捷入口、订阅设置
- ✅ 显示用户头像、昵称、状态
- ✅ 退出登录功能完整
- ⚠️ 使用uView组件（u-popup、u-switch）- 依赖WS-M0-001
- **结论**: ✅ 直接复用，仅需验证

**pages/user/profile.vue**（17行）：
- ❌ 仅占位页面：只有两个按钮（登录/注册、编辑资料）
- ❌ 无实际功能实现
- ❌ 无用户信息展示
- ❌ 无编辑表单
- **结论**: 🔴 需要完整实现（重构）

**uniCloud-aliyun/cloudfunctions/auth-me/index.js**（84行）：
- ✅ 使用uni-id验证token
- ✅ 返回用户信息
- ✅ 错误处理完善
- **结论**: ✅ 直接复用

### 核心任务拆解

1. **验证个人中心页面**（home.vue）
   - 验证用户信息展示
   - 验证退出登录功能
   - 验证订阅设置功能
   - 验证快捷入口跳转

2. **完整实现个人资料页**（profile.vue，重构）
   - 用户信息展示区（头像、昵称、uid、注册时间）
   - 资料编辑表单（昵称、头像、性别、生日、个人简介）
   - 头像上传功能
   - 保存按钮与数据同步
   - 加载状态与错误处理

3. **数据同步到云端**
   - 调用云函数更新用户信息
   - 本地缓存同步更新
   - 同步失败重试机制

4. **用户体验优化**
   - 表单验证（昵称长度、必填项）
   - 保存成功提示
   - 加载状态展示
   - 错误友好提示

---

## 影响范围

### 复用验证文件（1个）

- `pages/user/home.vue`（502行）- 个人中心首页
  - **复用策略**: ✅ 直接复用
  - **验证项**: uView组件、用户信息展示、退出登录
  - **风险**: 低

### 重构文件（1个）

- `pages/user/profile.vue`（17行 → 约500行）
  - **复用策略**: 🔴 完整重构
  - **实现内容**: 完整的个人资料编辑页面
  - **风险**: 中（需要完整开发）

### 复用云函数（1个）

- `uniCloud-aliyun/cloudfunctions/auth-me/index.js`（84行）
  - **复用策略**: ✅ 直接复用
  - **用途**: 获取用户信息
  - **风险**: 低

### 新建云函数（1个）

- `uniCloud-aliyun/cloudfunctions/user-update-profile/index.js`
  - **用途**: 更新用户信息到Supabase
  - **功能**: 昵称、头像、性别、生日、简介更新
  - **文件大小**: 约150行

### 复用工具（1个）

- `utils/unicloud-handler.js`
  - **复用策略**: ✅ 直接复用
  - **用途**: 调用云函数

---

## 依赖关系

### 前置依赖

- **WS-M0-001**: UI组件库统一
  - home.vue 使用 u-popup、u-switch
  - profile.vue 将使用 uView 表单组件

- **WS-M1-W1-001**: 微信登录验证
  - 需要登录态才能访问
  - 需要用户uid和基本信息

### 后置依赖

- **WS-M1-W1-006**: 路由守卫
  - profile页面需要登录保护

- **WS-M2-W5-001**: 本地存储加密
  - 用户信息加密存储

- **所有需要用户信息的页面**
  - 显示用户昵称/头像

---

## 数据流设计

### 获取用户信息流程

```
pages/user/home.vue (onShow)
  ↓
getLoginData() (utils/auth.js)
  ↓
从 uni.storage 读取
  ├─ uni_id_token
  ├─ uni_id_uid
  └─ uni_id_user_info
  ↓
展示用户信息
```

### 查询完整信息流程（可选）

```
pages/user/profile.vue (onLoad)
  ↓
调用 auth-me 云函数
  ↓
云函数验证 token（uni-id.checkToken）
  ↓
返回用户完整信息
  ↓
前端展示
```

### 更新用户信息流程

```
pages/user/profile.vue (保存按钮)
  ↓
表单验证（昵称长度、必填项）
  ↓
调用 user-update-profile 云函数
  ├─ 参数: { nickname, avatar, gender, birthday, bio }
  ├─ 验证: token、参数合法性
  └─ 处理: 更新 Supabase users 表
  ↓
云函数返回成功
  ↓
前端更新本地缓存（uni.storage）
  ├─ 更新 uni_id_user_info
  └─ 触发 AUTH_CHANGED 事件
  ↓
返回个人中心，显示更新后信息
```

### 头像上传流程

```
用户点击头像
  ↓
uni.chooseImage()
  ├─ 限制: 1张，压缩
  └─ 预览: 显示裁剪框（可选）
  ↓
图片压缩（< 500KB）
  ↓
uniCloud.uploadFile()
  ├─ 上传到云存储
  └─ 返回 URL
  ↓
调用 user-update-profile
  ├─ 参数: { avatar: url }
  └─ 更新数据库
  ↓
本地缓存更新
  ↓
页面显示新头像
```

---

## 风险提示

### 已识别风险

| 风险项 | 可能性 | 影响度 | 缓解措施 | 应急预案 | 状态 |
|--------|--------|--------|----------|----------|------|
| **profile.vue 需完整开发，工时可能超** | 高 | 中 | 1. 简化首版功能<br>2. 使用uView表单组件<br>3. 复用home.vue样式 | 延后非必需功能 | ⬜ 待验证 |
| **头像上传失败** | 中 | 低 | 1. 图片压缩<br>2. 重试机制<br>3. 本地缓存 | 允许不上传头像 | ⬜ 待验证 |
| **数据同步失败** | 中 | 中 | 1. 本地先更新<br>2. 后台同步<br>3. 失败提示 | 稍后重试同步 | ⬜ 待验证 |
| **昵称冲突/不合规** | 中 | 低 | 1. 前端验证<br>2. 后端检查<br>3. 提示修改 | 使用原昵称 | ⬜ 待验证 |
| **云存储空间不足** | 低 | 中 | 1. 限制图片大小<br>2. 监控空间<br>3. 清理旧图 | 暂停头像上传 | ⬜ 待验证 |
| **uni-id配置缺失** | 低 | 高 | 1. 验证uni-id配置<br>2. 文档说明<br>3. 错误提示 | 使用自定义验证 | ⬜ 待验证 |
| **表单输入卡顿** | 中 | 低 | 1. 防抖处理<br>2. 优化渲染<br>3. 禁用动画 | 简化表单 | ⬜ 待验证 |

### 风险监控

**检查频率**: 开发中每日检查

**监控指标**:
- 页面加载时间 < 1s
- 保存响应时间 < 2s
- 头像上传成功率 > 90%

**报告提交**: 发现工时超支立即上报

---

## 实施步骤摘要

### Step 1: 验证home.vue（1h）
- 手动测试所有功能
- 验证uView组件可用
- 确认退出登录正常

### Step 2: 开发profile.vue（2h）
- 页面布局设计
- 表单组件实现
- 头像上传功能
- 保存逻辑实现

### Step 3: 开发云函数（30min）
- user-update-profile实现
- 参数验证
- Supabase更新逻辑

### Step 4: 测试验证（30min）
- 表单功能测试
- 数据同步测试
- 异常场景测试

---

## 验证标准

### 功能验证

- [ ] home.vue 所有功能正常
- [ ] profile.vue 可编辑昵称
- [ ] profile.vue 可上传头像
- [ ] 可编辑性别、生日、简介
- [ ] 保存后数据同步到云端
- [ ] home.vue 显示更新后信息
- [ ] 退出登录清理数据

### 用户体验验证

- [ ] 页面加载流畅（< 1s）
- [ ] 表单输入顺畅
- [ ] 保存有loading提示
- [ ] 成功有反馈
- [ ] 失败有友好提示

### 数据验证

- [ ] 昵称长度限制（2-20字符）
- [ ] 头像格式限制（jpg/png，< 500KB）
- [ ] 生日格式正确
- [ ] 简介长度限制（< 200字）

---

## 交付清单

### 代码交付

- [ ] pages/user/profile.vue（完整实现，约500行）
- [ ] uniCloud-aliyun/cloudfunctions/user-update-profile/index.js（新建，约150行）
- [ ] uniCloud-aliyun/cloudfunctions/user-update-profile/package.json（新建）

### 文档交付

- [x] README.md（本文档）
- [ ] PLAN.md
- [ ] PATCH.md
- [ ] TESTS.md
- [ ] SELF-REVIEW.md
- [ ] ROLLBACK.md

### 测试交付

- [ ] 功能测试报告
- [ ] 表单验证测试
- [ ] 数据同步测试

---

## 后续任务

完成本工作流后，立即启动：

1. **WS-M1-W1-003**: 同意管理流程（依赖登录态）
2. **WS-M1-W1-006**: 路由守卫（保护profile页面）

---

## 时间线

| 时间点 | 事件 | 状态 |
|--------|------|------|
| 2025-10-12 | 创建五件套文档 | 🚧 进行中 |
| 待定 | 开始实施 | ⬜ 待开始 |
| 待定 | 完成开发 | ⬜ 待完成 |
| 待定 | 测试验证 | ⬜ 待测试 |
| 待定 | Code Review | ⬜ 待审核 |
| 待定 | 合并到 main | ⬜ 待合并 |

---

## 联系人

| 角色 | 姓名 | 职责 |
|------|------|------|
| 开发负责人 | 前端A | profile.vue开发 |
| 后端负责人 | 后端A | user-update-profile云函数 |
| Code Review | 前端Lead | 代码审核 |
| 测试负责人 | 测试工程师 | 功能测试 |

---

## 成功标准

### 必达目标（P0）

- [ ] ✅ pages/user/home.vue 验证通过
- [ ] ✅ pages/user/profile.vue 完整实现
- [ ] ✅ 可编辑昵称、头像、基本信息
- [ ] ✅ 数据同步到Supabase
- [ ] ✅ 所有测试通过

### 质量目标（P1）

- [ ] ✅ 构建 0 报错
- [ ] ✅ ESLint 0 errors
- [ ] ✅ 页面加载 < 1s
- [ ] ✅ 保存响应 < 2s

### 可选目标（P2）

- [ ] 头像裁剪功能
- [ ] 昵称重复检查
- [ ] 个性签名功能

---

## 参考资料

- [基线文档 - M1-Week1](../../../CraneHeart开发周期计划-用户端.md#week-1-1027-1031---基础模块)
- [phase1-wbs-workstreams.md](../../../docs/phase1-wbs-workstreams.md#ws-m1-w1-002用户信息页面完善)
- [uView表单组件文档](https://www.uviewui.com/components/form.html)

---

**文档版本**: v1.0  
**创建日期**: 2025-10-12  
**最后更新**: 2025-10-12  
**维护人**: AI Assistant

