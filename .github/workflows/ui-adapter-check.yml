name: UIé€‚é…æ£€æµ‹

on:
  push:
    branches: [ main, dev ]
    paths:
      - 'pages/**/*.vue'
      - 'pages-sub/**/*.vue'
      - 'components/**/*.vue'
      - 'tools/ui-adapter-checker.js'
  pull_request:
    branches: [ main, dev ]
    paths:
      - 'pages/**/*.vue'
      - 'pages-sub/**/*.vue'
      - 'components/**/*.vue'
      - 'tools/ui-adapter-checker.js'

jobs:
  ui-adapter-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
    
    - name: å®‰è£…ä¾èµ–
      run: npm install
    
    - name: è¿è¡ŒUIé€‚é…æ£€æµ‹
      run: node tools/ui-adapter-checker.js
      continue-on-error: true
    
    - name: ä¸Šä¼ æ£€æµ‹æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: ui-adapter-report
        path: ui-adapter-report.html
        retention-days: 30
    
    - name: è¯„è®ºPR
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const reportPath = 'ui-adapter-report.html';
          
          if (fs.existsSync(reportPath)) {
            const report = fs.readFileSync(reportPath, 'utf-8');
            
            // æå–ç»Ÿè®¡ä¿¡æ¯
            const errorMatch = report.match(/<div class="stat-value" style="color: #f56c6c;">(\d+)<\/div>/);
            const warningMatch = report.match(/<div class="stat-value" style="color: #e6a23c;">(\d+)<\/div>/);
            const infoMatch = report.match(/<div class="stat-value" style="color: #409eff;">(\d+)<\/div>/);
            
            const errors = errorMatch ? parseInt(errorMatch[1]) : 0;
            const warnings = warningMatch ? parseInt(warningMatch[1]) : 0;
            const infos = infoMatch ? parseInt(infoMatch[1]) : 0;
            
            let comment = '## ğŸ” UIé€‚é…æ£€æµ‹ç»“æœ\n\n';
            comment += `| ç±»å‹ | æ•°é‡ |\n`;
            comment += `|------|------|\n`;
            comment += `| âŒ é”™è¯¯ | ${errors} |\n`;
            comment += `| âš ï¸ è­¦å‘Š | ${warnings} |\n`;
            comment += `| â„¹ï¸ æç¤º | ${infos} |\n\n`;
            
            if (errors === 0 && warnings === 0) {
              comment += 'âœ… æ­å–œï¼æœªå‘ç°UIé€‚é…é—®é¢˜ã€‚\n\n';
            } else {
              comment += 'ğŸ“„ è¯¦ç»†æŠ¥å‘Šå·²ä¸Šä¼ ä¸ºå·¥ä»¶ï¼Œè¯·æŸ¥çœ‹ã€‚\n\n';
            }
            
            comment += '> ğŸ’¡ æç¤ºï¼šè¯·ç¡®ä¿æ‰€æœ‰é¡µé¢éƒ½é€‚é…äº†ä¸åŒå±å¹•å°ºå¯¸å’Œå®‰å…¨åŒºåŸŸã€‚';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }
    
    - name: æ£€æŸ¥é”™è¯¯
      run: |
        if [ -f ui-adapter-report.html ]; then
          ERROR_COUNT=$(grep -o 'level-error' ui-adapter-report.html | wc -l)
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "âŒ å‘ç° $ERROR_COUNT ä¸ªUIé€‚é…é”™è¯¯"
            exit 1
          fi
        fi

